<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniChaat + XO + Leaderboard</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ===== إعدادات عامة ===== */
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    direction: rtl;
}

.card {
    background: rgba(255, 255, 255, 0.9);
    width: 95%;
    max-width: 650px;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(to right, #6a11cb, #2575fc, #3b5cff);
}

h1, h2 {
    text-align: center;
    color: #3b5cff;
    margin: 0 0 15px 0;
    text-shadow: 1px 1px 5px rgba(0,0,0,0.1);
}

h1 {
    font-size: 1.8rem;
    position: relative;
    display: inline-block;
    align-self: center;
}

h1::after {
    content: '';
    position: absolute;
    bottom: -5px;
    right: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to left, transparent, #3b5cff, transparent);
}

/* ===== منطقة الرسائل ===== */
.messages-container {
    position: relative;
    margin-bottom: 15px;
}

.messages-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding: 0 5px;
}

.messages-header span {
    font-size: 0.9rem;
    color: #555;
    font-weight: bold;
}

#clear-chat {
    background: transparent;
    border: none;
    color: #ff4444;
    cursor: pointer;
    font-size: 0.8rem;
    padding: 5px 10px;
    border-radius: 15px;
    transition: all 0.3s;
}

#clear-chat:hover {
    background: rgba(255, 68, 68, 0.1);
}

.messages {
    flex: 1;
    border-radius: 15px;
    padding: 15px;
    overflow-y: auto;
    background: #f2f6ff;
    box-shadow: inset 0 5px 10px rgba(0,0,0,0.05);
    margin-bottom: 12px;
    font-size: 15px;
    min-height: 200px;
    max-height: 300px;
    display: flex;
    flex-direction: column-reverse; /* هذا يجعل الرسائل الجديدة تظهر في الأعلى */
}

/* إصلاح لفتح الرسائل من الأعلى */
.messages-content {
    display: flex;
    flex-direction: column;
}

.msg {
    padding: 10px 15px;
    border-radius: 15px;
    margin-bottom: 10px;
    word-wrap: break-word;
    font-weight: bold;
    animation: fadeIn 0.5s ease;
    cursor: default;
    transition: 0.3s;
    position: relative;
    align-self: flex-start;
    max-width: 85%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

.msg.user-msg {
    align-self: flex-end;
    background: linear-gradient(45deg, #3b5cff, #6a11cb);
    color: white;
}

.msg-username {
    font-size: 0.8rem;
    font-weight: bold;
    margin-bottom: 3px;
    display: flex;
    justify-content: space-between;
}

.msg-time {
    font-size: 0.7rem;
    font-weight: normal;
    opacity: 0.8;
}

.msg-text {
    font-size: 0.95rem;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes floatColor {
    0% { filter: hue-rotate(0deg); }
    50% { filter: hue-rotate(180deg); }
    100% { filter: hue-rotate(360deg); }
}

/* ===== منطقة الإدخال ===== */
.input-box {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.input-box input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 25px;
    border: 2px solid #ddd;
    outline: none;
    font-size: 15px;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s;
    font-family: 'Cairo', sans-serif;
}

.input-box input:focus {
    border-color: #3b5cff;
    box-shadow: 0 0 0 3px rgba(59, 92, 255, 0.2);
}

.input-box button {
    padding: 12px 25px;
    border-radius: 25px;
    border: none;
    background: linear-gradient(45deg, #3b5cff, #6a11cb);
    color: white;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    font-family: 'Cairo', sans-serif;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

.input-box button:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 15px rgba(0,0,0,0.25);
}

.input-box button:active {
    transform: scale(0.98);
}

/* ===== لعبة XO ===== */
.game-section {
    background: rgba(242, 246, 255, 0.7);
    border-radius: 15px;
    padding: 15px;
    margin-top: 10px;
}

.game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.current-turn {
    font-weight: bold;
    color: #3b5cff;
    font-size: 1.1rem;
    padding: 5px 15px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

#reset-game {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s;
}

#reset-game:hover {
    background: #ff5252;
    transform: scale(1.05);
}

#xo-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 0 auto;
    width: fit-content;
    background: white;
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

#xo-board button {
    width: 70px;
    height: 70px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 12px;
    border: 2px solid #3b5cff;
    background: #f8faff;
    transition: 0.3s;
    color: black; /* جعل الرموز سوداء */
}

#xo-board button.x {
    color: #ff4444; /* يمكنك تغيير هذا إذا أردت لونًا مختلفًا لـ X */
}

#xo-board button.o {
    color: #3b5cff; /* يمكنك تغيير هذا إذا أردت لونًا مختلفًا لـ O */
}

#xo-board button:hover {
    background: #e1e7ff;
    transform: scale(1.05);
}

#xo-board button:disabled {
    cursor: not-allowed;
    opacity: 0.8;
}

/* ===== المتصدرين ===== */
.leaderboard-container {
    margin-top: 20px;
    padding: 15px;
    background: #f2f6ff;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.leaderboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.leaderboard-header h3 {
    margin: 0;
    color: #3b5cff;
}

#refresh-leaderboard {
    background: transparent;
    border: none;
    color: #3b5cff;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s;
}

#refresh-leaderboard:hover {
    transform: rotate(180deg);
}

#leaderboard {
    max-height: 150px;
    overflow-y: auto;
    padding-right: 10px;
}

#leaderboard::-webkit-scrollbar {
    width: 6px;
}

#leaderboard::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.05);
    border-radius: 10px;
}

#leaderboard::-webkit-scrollbar-thumb {
    background: #3b5cff;
    border-radius: 10px;
}

.lb-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    margin-bottom: 8px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.lb-rank {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 0.8rem;
}

.lb-rank.gold { background: gold; color: #333; }
.lb-rank.silver { background: silver; }
.lb-rank.bronze { background: #cd7f32; }
.lb-rank.other { background: #6a11cb; }

.lb-name {
    flex: 1;
    margin: 0 15px;
    font-weight: bold;
}

.lb-score {
    font-weight: bold;
    color: #3b5cff;
}

/* ===== تذييل الصفحة ===== */
.footer {
    text-align: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    color: #666;
    font-size: 0.8rem;
}

.footer a {
    color: #3b5cff;
    text-decoration: none;
}

.footer a:hover {
    text-decoration: underline;
}

/* ===== رسالة الفائز ===== */
.winner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.5s;
}

.winner-overlay.show {
    opacity: 1;
    visibility: visible;
}

.winner-modal {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    transform: scale(0.8);
    transition: transform 0.5s;
}

.winner-overlay.show .winner-modal {
    transform: scale(1);
}

.winner-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.winner-text {
    font-size: 1.8rem;
    font-weight: bold;
    color: #3b5cff;
    margin-bottom: 15px;
}

.winner-desc {
    color: #666;
    margin-bottom: 20px;
}

/* ===== وسائط متجاوبة ===== */
@media (max-width: 600px) {
    .card {
        padding: 20px;
    }
    
    h1 {
        font-size: 1.5rem;
    }
    
    .messages {
        min-height: 180px;
        max-height: 250px;
    }
    
    #xo-board button {
        width: 60px;
        height: 60px;
        font-size: 24px;
    }
    
    .input-box button span {
        display: none;
    }
    
    .input-box button {
        padding: 12px 20px;
    }
}
</style>
</head>
<body>
<div class="card">
    <h1><i class="fas fa-comments"></i> MiniChaat + <i class="fas fa-gamepad"></i> XO</h1>
    
    <!-- منطقة الدردشة -->
    <div class="messages-container">
        <div class="messages-header">
            <span><i class="fas fa-comment-dots"></i> محادثة مباشرة</span>
            <button id="clear-chat"><i class="fas fa-trash-alt"></i> مسح المحادثة</button>
        </div>
        <div class="messages" id="messages">
            <div class="messages-content" id="messages-content"></div>
        </div>
    </div>
    
    <!-- إرسال الرسائل -->
    <div class="input-box">
        <input id="text" placeholder="اكتب رسالتك هنا..." />
        <button onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
            <span>إرسال</span>
        </button>
    </div>
    
    <!-- لعبة XO -->
    <div class="game-section">
        <h2><i class="fas fa-chess-board"></i> لعبة XO</h2>
        
        <div class="game-header">
            <div class="current-turn" id="current-turn">دور: <span id="turn-indicator">X</span></div>
            <button id="reset-game"><i class="fas fa-redo"></i> إعادة اللعبة</button>
        </div>
        
        <div id="xo-board">
            <button data-pos="0"></button>
            <button data-pos="1"></button>
            <button data-pos="2"></button>
            <button data-pos="3"></button>
            <button data-pos="4"></button>
            <button data-pos="5"></button>
            <button data-pos="6"></button>
            <button data-pos="7"></button>
            <button data-pos="8"></button>
        </div>
    </div>
    
    <!-- المتصدرين -->
    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h3><i class="fas fa-trophy"></i> المتصدرين</h3>
            <button id="refresh-leaderboard" title="تحديث القائمة">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div id="leaderboard">
            <div class="lb-item">
                <div class="lb-rank gold">1</div>
                <div class="lb-name">جار التحميل...</div>
                <div class="lb-score">0</div>
            </div>
        </div>
    </div>
    
    <!-- تذييل الصفحة -->
    <div class="footer">
        تم التطوير باستخدام Firebase | MiniChaat + XO &copy; 2023
    </div>
</div>

<!-- نافذة الفائز -->
<div class="winner-overlay" id="winner-overlay">
    <div class="winner-modal">
        <div class="winner-icon" id="winner-icon">🏆</div>
        <div class="winner-text" id="winner-text">!فاز X</div>
        <div class="winner-desc" id="winner-desc">تهانينا! لقد فازت باللعبة</div>
        <button id="close-winner" style="padding: 10px 25px; background: #3b5cff; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 1rem;">متابعة اللعب</button>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== إعدادات Firebase =====
const firebaseConfig = {
    apiKey: "AIzaSyCRwY0eiSttQIVT7iBHgcHQQosSpEAA-LM",
    authDomain: "minichaat-net.firebaseapp.com",
    projectId: "minichaat-net",
};

// تهيئة Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== المتغيرات العامة =====
let username = "";
let userColor = "#3b5cff";
let isX = true; // إذا كان المستخدم يلعب بـ X

// ===== تهيئة المستخدم =====
function initUser() {
    const savedUsername = localStorage.getItem("minichaat-username");
    const savedColor = localStorage.getItem("minichaat-color");
    
    if (savedUsername) {
        username = savedUsername;
        userColor = savedColor || "#3b5cff";
    } else {
        username = prompt("مرحبًا! ما اسمك؟") || "زائر";
        userColor = prompt("اختر لونك المفضل (اسم اللون أو HEX)") || "#3b5cff";
        
        // حفظ في التخزين المحلي
        localStorage.setItem("minichaat-username", username);
        localStorage.setItem("minichaat-color", userColor);
    }
    
    // عرض ترحيب
    addSystemMessage(`مرحبًا ${username}! يمكنك البدء بالدردشة واللعب.`);
}

// ===== الدردشة =====
const messagesContent = document.getElementById('messages-content');
const input = document.getElementById('text');

// إرسال رسالة
function sendMessage() {
    const text = input.value.trim();
    if (text === "") return;
    
    // إضافة الرسالة إلى Firebase
    db.collection("messages").add({
        name: username,
        text: text,
        color: userColor,
        time: Date.now(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    input.value = "";
    input.focus();
}

// تحويل HEX إلى RGB
function hexToRgb(hex) {
    let r = 0, g = 0, b = 0;
    
    if (hex.length === 4) {
        r = "0x" + hex[1] + hex[1];
        g = "0x" + hex[2] + hex[2];
        b = "0x" + hex[3] + hex[3];
    } else if (hex.length === 7) {
        r = "0x" + hex[1] + hex[2];
        g = "0x" + hex[3] + hex[4];
        b = "0x" + hex[5] + hex[6];
    }
    
    return [+r, +g, +b];
}

// حساب سطوع اللون
function getColorBrightness(color) {
    const rgb = hexToRgb(color);
    return (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
}

// إضافة رسالة نظام
function addSystemMessage(text) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg system-msg';
    msgDiv.innerHTML = `
        <div class="msg-username">
            <span><i class="fas fa-info-circle"></i> نظام</span>
        </div>
        <div class="msg-text">${text}</div>
    `;
    msgDiv.style.background = "#f0f0f0";
    msgDiv.style.color = "#666";
    
    // إضافة الرسالة في الأعلى
    messagesContent.insertBefore(msgDiv, messagesContent.firstChild);
    
    // تحديد عدد الرسائل والاحتفاظ بـ 50 رسالة كحد أقصى
    const allMessages = messagesContent.querySelectorAll('.msg');
    if (allMessages.length > 50) {
        messagesContent.removeChild(allMessages[allMessages.length - 1]);
    }
}

// عرض الرسائل من Firebase
db.collection("messages")
    .orderBy("timestamp", "desc")
    .limit(50)
    .onSnapshot(snapshot => {
        // مسح المحتوى الحالي
        messagesContent.innerHTML = "";
        
        snapshot.forEach(doc => {
            const data = doc.data();
            const msgDiv = document.createElement('div');
            
            // تحديد إذا كانت الرسالة للمستخدم الحالي
            const isCurrentUser = data.name === username;
            msgDiv.className = `msg ${isCurrentUser ? 'user-msg' : ''}`;
            
            // تنسيق الوقت
            const time = data.timestamp ? 
                new Date(data.timestamp.toDate()).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}) : 
                'الآن';
            
            msgDiv.innerHTML = `
                <div class="msg-username">
                    <span>${data.name}</span>
                    <span class="msg-time">${time}</span>
                </div>
                <div class="msg-text">${data.text}</div>
            `;
            
            // تعيين لون الخلفية
            msgDiv.style.background = data.color;
            
            // تعيين لون النص بناءً على سطوع الخلفية
            const brightness = getColorBrightness(data.color);
            msgDiv.style.color = (brightness > 125) ? "#333" : "#fff";
            
            // إضافة زر الحذف إذا كانت الرسالة للمستخدم الحالي
            if (isCurrentUser) {
                msgDiv.style.cursor = "pointer";
                msgDiv.title = "انقر لحذف هذه الرسالة";
                msgDiv.addEventListener("click", () => {
                    if (confirm("هل تريد حذف هذه الرسالة؟")) {
                        db.collection("messages").doc(doc.id).delete();
                    }
                });
            }
            
            // إضافة الرسالة إلى المحتوى
            messagesContent.appendChild(msgDiv);
        });
        
        // إذا لم تكن هناك رسائل، إضافة رسالة ترحيب
        if (snapshot.empty) {
            addSystemMessage("كن أول من يرسل رسالة!");
        }
    });

// الاستماع لزر Enter
input.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
});

// مسح المحادثة
document.getElementById('clear-chat').addEventListener('click', () => {
    if (confirm("هل تريد مسح كل الرسائل؟ لا يمكن التراجع عن هذا الإجراء.")) {
        // حذف جميع رسائل المستخدم الحالي فقط
        db.collection("messages").where("name", "==", username)
            .get()
            .then(snapshot => {
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                return batch.commit();
            })
            .then(() => {
                addSystemMessage("تم حذف رسائلك.");
            });
    }
});

// ===== لعبة XO =====
const xoBoard = document.getElementById("xo-board");
const cells = xoBoard.querySelectorAll("button");
const turnIndicator = document.getElementById("turn-indicator");
const resetGameBtn = document.getElementById("reset-game");
let turn = "X";
let gameOver = false;

// تحديث المؤشر
function updateTurnIndicator() {
    turnIndicator.textContent = turn;
    turnIndicator.style.color = turn === "X" ? "#ff4444" : "#3b5cff";
}

// التحقق من الفائز
function checkWinner(board) {
    const combos = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8], // صفوف
        [0, 3, 6], [1, 4, 7], [2, 5, 8], // أعمدة
        [0, 4, 8], [2, 4, 6]             // أقطار
    ];
    
    for (const combo of combos) {
        if (board[combo[0]] && 
            board[combo[0]] === board[combo[1]] && 
            board[combo[0]] === board[combo[2]]) {
            return board[combo[0]];
        }
    }
    
    // التحقق من التعادل
    if (board.every(cell => cell !== "")) {
        return "tie";
    }
    
    return null;
}

// عرض نافذة الفائز
function showWinner(winner) {
    const overlay = document.getElementById("winner-overlay");
    const winnerText = document.getElementById("winner-text");
    const winnerDesc = document.getElementById("winner-desc");
    const winnerIcon = document.getElementById("winner-icon");
    
    if (winner === "tie") {
        winnerText.textContent = "!تعادل";
        winnerDesc.textContent = "لا فائز هذه المرة، حاول مرة أخرى!";
        winnerIcon.textContent = "🤝";
    } else {
        winnerText.textContent = `!فاز ${winner}`;
        winnerDesc.textContent = winner === (isX ? "X" : "O") ? 
            "تهانينا! لقد فازت باللعبة" : 
            "حظ أوفر في المرة القادمة!";
        winnerIcon.textContent = winner === (isX ? "X" : "O") ? "🏆" : "🎮";
        
        // تحديث النقاط إذا فاز المستخدم
        if (winner === (isX ? "X" : "O")) {
            const scoreDoc = db.collection("scores").doc(username);
            scoreDoc.get().then(doc => {
                if (doc.exists) {
                    scoreDoc.update({score: firebase.firestore.FieldValue.increment(1)});
                } else {
                    scoreDoc.set({name: username, score: 1});
                }
                updateLeaderboard();
            });
        }
    }
    
    overlay.classList.add("show");
}

// إعادة تعيين اللعبة
function resetGame() {
    cells.forEach(cell => {
        cell.textContent = "";
        cell.disabled = false;
        cell.classList.remove("x", "o");
        cell.style.transform = "scale(1)";
    });
    
    turn = "X";
    gameOver = false;
    updateTurnIndicator();
}

// حدث النقر على خلية
cells.forEach(cell => {
    cell.addEventListener("click", () => {
        if (gameOver || cell.textContent !== "") return;
        
        // تعيين الرمز
        cell.textContent = turn;
        cell.classList.add(turn.toLowerCase());
        
        // تأثير مرئي
        cell.style.transform = "scale(1.1)";
        setTimeout(() => cell.style.transform = "scale(1)", 150);
        
        // التحقق من الفائز
        const board = Array.from(cells).map(c => c.textContent);
        const winner = checkWinner(board);
        
        if (winner) {
            gameOver = true;
            cells.forEach(c => c.disabled = true);
            
            setTimeout(() => {
                showWinner(winner);
            }, 500);
        } else {
            // تغيير الدور
            turn = turn === "X" ? "O" : "X";
            updateTurnIndicator();
        }
    });
});

// إعادة تعيين اللعبة
resetGameBtn.addEventListener("click", resetGame);

// إغلاق نافذة الفائز
document.getElementById("close-winner").addEventListener("click", () => {
    document.getElementById("winner-overlay").classList.remove("show");
    resetGame();
});

// ===== المتصدرين =====
function updateLeaderboard() {
    const leaderboard = document.getElementById("leaderboard");
    
    db.collection("scores")
        .orderBy("score", "desc")
        .limit(10)
        .get()
        .then(snapshot => {
            leaderboard.innerHTML = "";
            
            if (snapshot.empty) {
                leaderboard.innerHTML = '<div class="lb-item"><div class="lb-name" style="text-align:center; width:100%;">لا توجد نتائج بعد</div></div>';
                return;
            }
            
            let rank = 0;
            snapshot.forEach(doc => {
                rank++;
                const data = doc.data();
                const lbItem = document.createElement("div");
                lbItem.className = "lb-item";
                
                // تحديد فئة الرتبة
                let rankClass = "other";
                if (rank === 1) rankClass = "gold";
                else if (rank === 2) rankClass = "silver";
                else if (rank === 3) rankClass = "bronze";
                
                // تحديد إذا كان المستخدم الحالي
                const isCurrentUser = data.name === username;
                
                lbItem.innerHTML = `
                    <div class="lb-rank ${rankClass}">${rank}</div>
                    <div class="lb-name" style="${isCurrentUser ? 'color:#3b5cff; font-weight:bold;' : ''}">
                        ${isCurrentUser ? '<i class="fas fa-user" style="margin-left:5px;"></i>' : ''}
                        ${data.name}
                    </div>
                    <div class="lb-score">${data.score}</div>
                `;
                
                leaderboard.appendChild(lbItem);
            });
        })
        .catch(error => {
            console.error("Error updating leaderboard:", error);
            leaderboard.innerHTML = '<div class="lb-item"><div class="lb-name" style="text-align:center; width:100%;">خطأ في تحميل النتائج</div></div>';
        });
}

// تحديث المتصدرين
document.getElementById("refresh-leaderboard").addEventListener("click", updateLeaderboard);

// ===== تهيئة الصفحة =====
document.addEventListener("DOMContentLoaded", () => {
    initUser();
    updateTurnIndicator();
    updateLeaderboard();
    
    // تحديث المتصدرين كل 30 ثانية
    setInterval(updateLeaderboard, 30000);
});
</script>
</body>
</html>